<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>UI Reviewer</title>
  <style>
    body { font-family: sans-serif; padding: 10px; }
    textarea { width: 100%; height: 100px; margin-bottom: 10px; box-sizing: border-box; }
    input[type="password"] { width: 100%; margin-bottom: 10px; padding: 8px; box-sizing: border-box; }
    button { padding: 10px 15px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; margin-right: 5px; }
    button:hover { background-color: #0056b3; }
    button:disabled { background-color: #cccccc; cursor: not-allowed; }
    #result { margin-top: 15px; padding: 10px; border: 1px solid #ccc; border-radius: 5px; position: relative; }
    .loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid #3498db; width: 20px; height: 20px; animation: spin 1s linear infinite; display: none; margin: 10px auto; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .button-group { margin-top: 10px; }
    .error-message { color: red; font-weight: bold; }
    .review-content { white-space: pre-wrap; word-wrap: break-word; }
  </style>
</head>
<body>
  <h2>UI Reviewer</h2>
  <p>Select a frame in Figma, enter your API key, and click "Get Review".</p>
  <label for="apiKey">Gemini API Key:</label>
  <input type="password" id="apiKey" placeholder="Enter your Gemini API Key">

  <label for="additionalPrompt">Additional Instructions (Optional):</label>
  <textarea id="additionalPrompt" placeholder="e.g., Focus on accessibility, suggest a different color palette."></textarea>

  <button id="getReview">Get Review</button>
  <div class="loader" id="loader"></div>
  <div id="result">
    <p>Review will appear here.</p>
  </div>
  <div class="button-group">
    <button id="copyReview" style="display:none;">Copy Review</button>
    <button id="clearResult" style="display:none;">Clear Result</button>
  </div>

  <script>
    const apiKeyInput = document.getElementById('apiKey');
    const additionalPromptInput = document.getElementById('additionalPrompt');
    const getReviewButton = document.getElementById('getReview');
    const resultDiv = document.getElementById('result');
    const loader = document.getElementById('loader');
    const copyReviewButton = document.getElementById('copyReview');
    const clearResultButton = document.getElementById('clearResult');

    const setUiLoadingState = (isLoading) => {
      getReviewButton.disabled = isLoading;
      loader.style.display = isLoading ? 'block' : 'none';
    };

    getReviewButton.onclick = () => {
      const apiKey = apiKeyInput.value;
      const additionalPrompt = additionalPromptInput.value;
      if (!apiKey) {
        resultDiv.innerHTML = '<p class="error-message">Please enter your Gemini API Key.</p>';
        apiKeyInput.style.borderColor = 'red'; // Highlight API key input
        return;
      }
      apiKeyInput.style.borderColor = ''; // Reset border color
      setUiLoadingState(true);
      resultDiv.innerHTML = '<p>Getting review...</p>';
      copyReviewButton.style.display = 'none';
      clearResultButton.style.display = 'none';
      parent.postMessage({ pluginMessage: { type: 'get-review', apiKey: apiKey, additionalPrompt: additionalPrompt } }, '*');
    };

    copyReviewButton.onclick = () => {
      const reviewText = resultDiv.querySelector('pre')?.innerText;
      if (reviewText) {
        navigator.clipboard.writeText(reviewText)
          .then(() => { alert('Review copied to clipboard!'); })
          .catch(err => { console.error('Failed to copy: ', err); alert('Failed to copy review.'); });
      }
    };

    clearResultButton.onclick = () => {
      resultDiv.innerHTML = '<p>Review will appear here.</p>';
      copyReviewButton.style.display = 'none';
      clearResultButton.style.display = 'none';
    };

    window.onmessage = (event) => {
      const message = event.data.pluginMessage;
      setUiLoadingState(false); // Stop loading on any message from plugin

      if (message.type === 'review-result') {
        resultDiv.innerHTML = `<p><strong>Review:</strong></p><pre class="review-content">${message.review}</pre>`;
        copyReviewButton.style.display = 'inline-block';
        clearResultButton.style.display = 'inline-block';
      } else if (message.type === 'error') {
        resultDiv.innerHTML = `<p class="error-message"><strong>Error:</strong> ${message.error}</p>`;
        copyReviewButton.style.display = 'none';
        clearResultButton.style.display = 'none';
      } else if (message.type === 'loading') { // Explicitly handle loading message if needed, though setUiLoadingState covers it
         resultDiv.innerHTML = `<p>${message.message || 'Processing...'}</p>`;
         setUiLoadingState(true);
      }
    };
  </script>
</body>
</html>
